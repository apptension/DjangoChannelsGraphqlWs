<!DOCTYPE html>
<!--
# Copyright (C) DATADVANCE, 2010-2023
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
# CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
# TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<html>
    <head>
        <title>GraphiQL</title>
        <style>
            body {
                height: 100%;
                margin: 0;
                width: 100%;
                overflow: hidden;
            }

            #graphiql {
                height: 100vh;
            }
        </style>
        <link rel="stylesheet" href="https://unpkg.com/graphiql@2.4.1/graphiql.min.css" />
        <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/graphiql@2.4.1/graphiql.min.js" type="application/javascript"></script>
        <script src="https://unpkg.com/graphql-ws@5.12.1/umd/graphql-ws.min.js" type="application/javascript"></script>
        <!-- https://unpkg.com/@n1ru4l/push-pull-async-iterable-iterator@3.2.0/index.js -->
        <script
            src="push-pull-async-iterable-iterator/index.js"
            type="text/javascript"
        ></script>
    </head>

    <body>
        <div id="graphiql">Loading...</div>
        <script>
            const createWebsocketsFetcherFromClient = (wsClient) => (graphQLParams) =>
                makeAsyncIterableIteratorFromSink((sink) =>
                    wsClient.subscribe(graphQLParams, {
                        ...sink,
                        error: (err) => {
                            if (err instanceof CloseEvent) {
                                sink.error(
                                    new Error(
                                        `Socket closed with event ${err.code} ${
                                            err.reason || ""
                                        }`.trim(),
                                    ),
                                );
                            } else {
                                sink.error(err);
                            }
                        },
                    }),
                );

            // Setup subscription client.
            const GRAPHQL_ENDPOINT =
                (location.protocol === "https" ? "wss" : "ws") +
                "://" +
                location.host +
                "/graphql/";
            let subClient = graphqlWs.createClient({
                url: GRAPHQL_ENDPOINT,
                shouldRetry: () => true,
                keepAlive: 60000,
            });

            ReactDOM.render(
                React.createElement(GraphiQL, {
                    fetcher: createWebsocketsFetcherFromClient(subClient),
                    defaultEditorToolsVisibility: true,
                }),
                document.getElementById("graphiql"),
            );
        </script>
    </body>
</html>
